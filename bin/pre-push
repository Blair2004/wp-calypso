#!/bin/sh

remote="$1"
url="$2"
sha40=0000000000000000000000000000000000000000

echo "\nBy contributing to this project, you license the materials you contribute under the GNU General Public License v2 (or later). All materials must have GPLv2 compatible licenses â€” see .github/CONTRIBUTING.md for details.\n\n"

while read local_ref local_sha remote_ref remote_sha
do
	# echo "l_ref $local_ref l_sha $local_sha r_ref $remote_ref r_sha $remote_sha"

	# PUSH TO DELETE BRANCH - git push origin :master
	if [ "$local_sha" = "$sha40" ]
	then
		if [ "refs/heads/master" = "$remote_ref" ]
		then
			echo "\n\033[41mPUSH ABORTED:\033[0m you are about to DELETE remote master. If that is what you intended, repeat the command with --no-verify to avoid this check.\n"
			exit 1 # push would not be executed
		fi

		# Any other branch would be OK
		exit 0 # push would be executed

	fi

	# PUSH TO MASTER - git push origin master:master
	if [ "refs/heads/master" = "$remote_ref" ]
	then
		echo "\n\033[41mPUSH ABORTED:\033[0m you are about to PUSH to remote master. If that is what you intended, repeat the command with --no-verify to avoid this check.\n"

		echo "Running the linter in the whole codebase. This may take a while."
		./bin/run-lint .
		linter_exit_code=`echo $?` # take exit code from run-lint script
		if [ ! 0 = "$linter_exit_code" ]
		then
			echo "\nThe linter has reported some parsing errors in the code you intended to push. Please, resolve them before pushing to master.\n"
		fi

		exit 1 # push would not be executed
	fi

	# PUSH TO TOPIC BRANCH - git push origin topic-branch:topic-branch
	export ESLINES_BRANCH=$local_ref;
	./bin/run-lint $(git diff --name-only $(git merge-base $(git rev-parse --abbrev-ref $local_ref) origin/master)..HEAD server/ client/)
	linter_exit_code=`echo $?` # take exit code from run-lint script
	if [ ! 0 = "$linter_exit_code" ]
	then
		echo "\n\033[41mPUSH ABORTED:\033[0m the linter reported some problems. If you are aware of them and it is OK, you can repeat the command with --no-verify to avoid this check.\n"
	fi
	exit $linter_exit_code

done

exit 0
