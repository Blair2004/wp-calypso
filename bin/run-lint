#!/usr/bin/env node
const child_process = require( 'child_process' );
const path = require( 'path' );
const stylish = require( 'eslint/lib/formatters/stylish' );
const exitCodeFromEslint = require( './eslint-formatters-calypso/src/lib/exit-code' );

var args = [ '--cache', '--quiet', '--ext=.js', '--ext=.jsx', '--format=json' ];
if ( process.argv.length > 2 ) {
	args = args.concat( process.argv.slice( 2 ) );
} else {
	args = args.concat( [ '--format=json', '.' ] );
}

const results = child_process.spawnSync( path.join( '.', 'node_modules', '.bin', 'eslint' ), args );
const report = JSON.parse( results.stdout.toString() );

if ( results.stdout ) {
	process.stdout.write( stylish( report ) );
}
if ( results.stderr ) {
	process.stderr.write( results.stderr );
}

process.on( 'exit', function() {
	if( results.stdout ){
	    process.exit( exitCodeFromEslint( report ) );
	}
	process.exit( results.status );
} );
